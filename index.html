<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Threads è‡ªå‹•æŠ•ç¨¿ãã‚“</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d0d0f;
    --surface: #18181c;
    --surface2: #222228;
    --border: #2e2e38;
    --accent: #7c6dfa;
    --accent2: #a78bfa;
    --text: #e8e8f0;
    --muted: #888898;
    --success: #34d399;
    --error: #f87171;
    --warn: #fbbf24;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 40px 16px 80px;
  }

  .container {
    width: 100%;
    max-width: 640px;
  }

  /* Header */
  .header {
    margin-bottom: 36px;
    animation: fadeUp 0.5s ease both;
  }

  .header-eyebrow {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--accent2);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .header h1 {
    font-size: 28px;
    font-weight: 700;
    line-height: 1.2;
  }

  .header p {
    margin-top: 8px;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.6;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
    animation: fadeUp 0.5s ease both;
  }

  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }

  .card-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.18em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  /* Form inputs */
  input[type="text"], input[type="password"], textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 14px;
    padding: 12px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
    border-color: var(--accent);
  }

  input[type="text"]::placeholder, textarea::placeholder {
    color: var(--muted);
  }

  textarea {
    resize: vertical;
    min-height: 140px;
    line-height: 1.7;
  }

  .input-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .input-group label {
    font-size: 13px;
    color: var(--muted);
  }

  /* Buttons */
  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 700;
    font-size: 15px;
    padding: 13px 20px;
    transition: all 0.2s;
    width: 100%;
  }

  .btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:not(:disabled):hover {
    background: var(--accent2);
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success);
    color: #0d0d0f;
  }

  .btn-success:not(:disabled):hover {
    opacity: 0.88;
    transform: translateY(-1px);
  }

  .btn-outline {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 13px;
    padding: 10px 16px;
    width: auto;
  }

  .btn-outline:hover {
    border-color: var(--accent);
    color: var(--accent2);
  }

  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
  }

  .btn-row .btn { flex: 1; }

  /* Spinner */
  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }

  .loading .spinner { display: block; }
  .loading .btn-text { display: none; }

  /* Status badge */
  .status {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 12px 14px;
    border-radius: 10px;
    font-size: 13px;
    margin-top: 14px;
    line-height: 1.5;
  }

  .status.show { display: flex; }
  .status.success { background: rgba(52,211,153,0.12); color: var(--success); border: 1px solid rgba(52,211,153,0.25); }
  .status.error { background: rgba(248,113,113,0.12); color: var(--error); border: 1px solid rgba(248,113,113,0.25); }
  .status.info { background: rgba(124,109,250,0.12); color: var(--accent2); border: 1px solid rgba(124,109,250,0.25); }

  /* Char count */
  .char-count {
    text-align: right;
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
    font-family: 'Space Mono', monospace;
  }

  .char-count.over { color: var(--error); }

  /* Step indicator */
  .steps {
    display: flex;
    gap: 6px;
    margin-bottom: 28px;
    animation: fadeUp 0.5s ease both;
  }

  .step {
    flex: 1;
    height: 3px;
    border-radius: 2px;
    background: var(--border);
    transition: background 0.4s;
  }

  .step.active { background: var(--accent); }
  .step.done { background: var(--success); }

  /* Settings toggle */
  .settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
  }

  .settings-toggle .arrow {
    color: var(--muted);
    transition: transform 0.3s;
    font-size: 12px;
  }

  .settings-toggle.open .arrow { transform: rotate(180deg); }

  .settings-body {
    display: none;
    margin-top: 16px;
  }

  .settings-body.open { display: block; }

  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 20px 0;
  }

  /* Info tooltip */
  .info-link {
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
    display: block;
  }

  .info-link a { color: var(--accent2); text-decoration: none; }
  .info-link a:hover { text-decoration: underline; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-eyebrow">âœ¦ AI Powered</div>
    <h1>Threads è‡ªå‹•æŠ•ç¨¿ãã‚“</h1>
    <p>ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸ã‚“ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã€‚AIãŒæŠ•ç¨¿æ–‡ã‚’è€ƒãˆã¦ã€Threadsã«æŠ•ç¨¿ã—ã¾ã™ã€‚</p>
  </div>

  <div class="steps">
    <div class="step active" id="step1"></div>
    <div class="step" id="step2"></div>
    <div class="step" id="step3"></div>
  </div>

  <!-- STEP 1: APIè¨­å®š -->
  <div class="card" id="card-settings">
    <div class="settings-toggle" id="settingsToggle">
      <div class="card-label" style="margin-bottom:0">âš™ï¸ APIè¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰</div>
      <span class="arrow">â–¼</span>
    </div>
    <div class="settings-body" id="settingsBody">
      <div class="input-row" style="margin-top:4px">
        <div class="input-group">
          <label>Claude APIã‚­ãƒ¼</label>
          <input type="password" id="claudeKey" placeholder="sk-ant-..." autocomplete="off">
          <span class="info-link">â†’ <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ã§å–å¾—</span>
        </div>
        <div class="input-group">
          <label>Threads ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</label>
          <input type="password" id="threadsToken" placeholder="THR..." autocomplete="off">
        </div>
        <div class="input-group">
          <label>Threads ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæ•°å­—ï¼‰</label>
          <input type="text" id="threadsUserId" placeholder="123456789">
          <span class="info-link">å–å¾—æ–¹æ³•: <a href="https://developers.facebook.com/docs/threads" target="_blank">Meta Developers â†’ Threads</a></span>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-outline" onclick="saveSettings()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
      </div>
      <div id="settings-status" class="status"></div>
    </div>
  </div>

  <!-- STEP 2: æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ -->
  <div class="card">
    <div class="card-label">â‘  æŠ•ç¨¿ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å…¥åŠ›</div>
    <input type="text" id="genre" placeholder="ä¾‹: ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»AIã€ç¾å®¹ã€æŠ•è³‡ã€æ–™ç†â€¦" value="ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»AI">
    <div class="btn-row">
      <button class="btn btn-primary" id="generateBtn" onclick="generatePost()">
        <span class="spinner" id="gen-spinner"></span>
        <span class="btn-text">âœ¨ æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ</span>
      </button>
    </div>
    <div id="gen-status" class="status"></div>
  </div>

  <!-- STEP 3: ç¢ºèªãƒ»æŠ•ç¨¿ -->
  <div class="card" id="card-post" style="display:none">
    <div class="card-label">â‘¡ å†…å®¹ã‚’ç¢ºèªã—ã¦æŠ•ç¨¿</div>
    <textarea id="postText" placeholder="ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿æ–‡ãŒã“ã“ã«å…¥ã‚Šã¾ã™"></textarea>
    <div class="char-count" id="charCount">0 / 500æ–‡å­—</div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="generatePost()" style="flex:0.6">ğŸ”„ å†ç”Ÿæˆ</button>
      <button class="btn btn-success" id="postBtn" onclick="postToThreads()">
        <span class="spinner" id="post-spinner"></span>
        <span class="btn-text">Threadsã«æŠ•ç¨¿ â†’</span>
      </button>
    </div>
    <div id="post-status" class="status"></div>
  </div>
</div>

<script>
// ========================================
// è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
// ========================================

function saveSettings() {
  const claudeKey = document.getElementById('claudeKey').value.trim();
  const threadsToken = document.getElementById('threadsToken').value.trim();
  const threadsUserId = document.getElementById('threadsUserId').value.trim();

  if (!claudeKey || !threadsToken || !threadsUserId) {
    showStatus('settings-status', 'error', 'âŒ 3ã¤ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¸€æ™‚ä¿å­˜ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ã¿ï¼‰
  sessionStorage.setItem('claudeKey', claudeKey);
  sessionStorage.setItem('threadsToken', threadsToken);
  sessionStorage.setItem('threadsUserId', threadsUserId);

  showStatus('settings-status', 'success', 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
  updateSteps(1);
}

function loadSettings() {
  const keys = ['claudeKey', 'threadsToken', 'threadsUserId'];
  keys.forEach(k => {
    const val = sessionStorage.getItem(k);
    if (val) document.getElementById(k).value = val;
  });
}

// è¨­å®šãƒ‘ãƒãƒ«ã®é–‹é–‰
document.getElementById('settingsToggle').addEventListener('click', () => {
  const toggle = document.getElementById('settingsToggle');
  const body = document.getElementById('settingsBody');
  toggle.classList.toggle('open');
  body.classList.toggle('open');
});

// åˆå›ã¯è¨­å®šã‚’é–‹ã
document.getElementById('settingsToggle').classList.add('open');
document.getElementById('settingsBody').classList.add('open');

// ========================================
// â‘  æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆï¼ˆClaude APIï¼‰
// ========================================

async function generatePost() {
  const claudeKey = sessionStorage.getItem('claudeKey');
  const genre = document.getElementById('genre').value.trim();

  if (!claudeKey) {
    showStatus('gen-status', 'error', 'âŒ å…ˆã«APIè¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
    return;
  }

  if (!genre) {
    showStatus('gen-status', 'error', 'âŒ ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  setLoading('generateBtn', 'gen-spinner', true);
  showStatus('gen-status', 'info', 'ğŸ¤– AIãŒæŠ•ç¨¿æ–‡ã‚’è€ƒãˆã¦ã„ã¾ã™â€¦');

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': claudeKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-6',
        max_tokens: 500,
        system: `ã‚ãªãŸã¯${genre}ã®å°‚é–€å®¶ã§ã™ã€‚Threadsã«æŠ•ç¨¿ã™ã‚‹ãŸã‚ã®çŸ­ã„æ—¥æœ¬èªã®æŠ•ç¨¿æ–‡ã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚\nãƒ«ãƒ¼ãƒ«:\n- 500æ–‡å­—ä»¥å†…\n- èª­è€…ãŒã€Œãªã‚‹ã»ã©ï¼ã€ã¨æ€ãˆã‚‹å†…å®¹\n- è¦ªã—ã¿ã‚„ã™ã„ãƒˆãƒ¼ãƒ³\n- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’2ã€œ3å€‹æœ«å°¾ã«è¿½åŠ \n- æŠ•ç¨¿æ–‡ã®ã¿ã‚’è¿”ã™ï¼ˆå‰ç½®ãä¸è¦ï¼‰`,
        messages: [{ role: 'user', content: `ä»Šæ—¥ã®${genre}ã«é–¢ã™ã‚‹æŠ•ç¨¿ã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚` }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || `APIã‚¨ãƒ©ãƒ¼ (${response.status})`);
    }

    const data = await response.json();
    const text = data.content[0].text.trim();

    document.getElementById('postText').value = text;
    document.getElementById('card-post').style.display = 'block';
    updateCharCount();
    updateSteps(2);
    showStatus('gen-status', 'success', 'âœ… ç”Ÿæˆå®Œäº†ï¼å†…å®¹ã‚’ç¢ºèªã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„');
    document.getElementById('card-post').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  } catch (e) {
    showStatus('gen-status', 'error', `âŒ ${e.message}`);
  } finally {
    setLoading('generateBtn', 'gen-spinner', false);
  }
}

// ========================================
// â‘¡ Threadsã«æŠ•ç¨¿
// ========================================

async function postToThreads() {
  const threadsToken = sessionStorage.getItem('threadsToken');
  const threadsUserId = sessionStorage.getItem('threadsUserId');
  const text = document.getElementById('postText').value.trim();

  if (!threadsToken || !threadsUserId) {
    showStatus('post-status', 'error', 'âŒ APIè¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
    return;
  }

  if (!text) {
    showStatus('post-status', 'error', 'âŒ æŠ•ç¨¿æ–‡ãŒç©ºã§ã™');
    return;
  }

  if (text.length > 500) {
    showStatus('post-status', 'error', 'âŒ 500æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„');
    return;
  }

  if (!confirm('ã“ã®å†…å®¹ã§Threadsã«æŠ•ç¨¿ã—ã¾ã™ã‹ï¼Ÿ')) return;

  setLoading('postBtn', 'post-spinner', true);
  showStatus('post-status', 'info', 'ğŸ“¤ æŠ•ç¨¿ã—ã¦ã„ã¾ã™â€¦');

  try {
    // Step 1: ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
    const containerRes = await fetch(
      `https://graph.threads.net/v1.0/${threadsUserId}/threads?media_type=TEXT&text=${encodeURIComponent(text)}&access_token=${threadsToken}`,
      { method: 'POST' }
    );
    if (!containerRes.ok) {
      const err = await containerRes.json();
      throw new Error(err.error?.message || `ã‚³ãƒ³ãƒ†ãƒŠä½œæˆå¤±æ•— (${containerRes.status})`);
    }
    const containerData = await containerRes.json();
    const containerId = containerData.id;

    // å°‘ã—å¾…æ©Ÿ
    await new Promise(r => setTimeout(r, 3000));

    // Step 2: å…¬é–‹
    const publishRes = await fetch(
      `https://graph.threads.net/v1.0/${threadsUserId}/threads_publish?creation_id=${containerId}&access_token=${threadsToken}`,
      { method: 'POST' }
    );
    if (!publishRes.ok) {
      const err = await publishRes.json();
      throw new Error(err.error?.message || `å…¬é–‹å¤±æ•— (${publishRes.status})`);
    }

    const publishData = await publishRes.json();
    showStatus('post-status', 'success', `ğŸ‰ æŠ•ç¨¿å®Œäº†ï¼Post ID: ${publishData.id}`);
    updateSteps(3);

  } catch (e) {
    showStatus('post-status', 'error', `âŒ ${e.message}`);
  } finally {
    setLoading('postBtn', 'post-spinner', false);
  }
}

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================

function showStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = `status show ${type}`;
  el.textContent = msg;
}

function setLoading(btnId, spinnerId, isLoading) {
  const btn = document.getElementById(btnId);
  const spinner = document.getElementById(spinnerId);
  btn.disabled = isLoading;
  spinner.style.display = isLoading ? 'block' : 'none';
}

function updateCharCount() {
  const text = document.getElementById('postText').value;
  const count = text.length;
  const el = document.getElementById('charCount');
  el.textContent = `${count} / 500æ–‡å­—`;
  el.className = count > 500 ? 'char-count over' : 'char-count';
}

document.getElementById('postText')?.addEventListener('input', updateCharCount);

function updateSteps(step) {
  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById(`step${i}`);
    el.className = 'step' + (i < step ? ' done' : i === step ? ' active' : '');
  }
}

// èµ·å‹•æ™‚ã«ä¿å­˜æ¸ˆã¿è¨­å®šã‚’èª­ã¿è¾¼ã‚€
loadSettings();
</script>
</body>
</html>
