name: Threads 自動投稿

on:
  schedule:
    - cron: '0 0 * * *'   # 日本時間 09:00
    - cron: '0 6 * * *'   # 日本時間 15:00
    - cron: '0 12 * * *'  # 日本時間 21:00
  workflow_dispatch: # 手動実行ボタンも追加

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: 投稿を実行
        run: |
          python3 - <<'EOF'
          import urllib.request
          import urllib.parse
          import json
          import time
          import os

          CLAUDE_API_KEY  = os.environ['CLAUDE_API_KEY']
          THREADS_TOKEN   = os.environ['THREADS_TOKEN']
          THREADS_USER_ID = os.environ['THREADS_USER_ID']
          GENRE           = os.environ.get('GENRE', 'テクノロジー・AI')

          # 1. Claude APIで投稿文を生成
          payload = json.dumps({
            "model": "claude-opus-4-6",
            "max_tokens": 500,
            "system": f"あなたは{GENRE}が大好きな普通の人です。Threadsに投稿する日本語の文章を1つ書いてください。\nルール:\n- 7行以内\n- AIっぽくない、人間らしい自然な口調\n- 友達に話しかけるような砕けた感じ\n- 難しい言葉は使わない\n- ハッシュタグを2〜3個末尾に追加\n- 投稿文のみを返す",
            "messages": [{"role": "user", "content": f"{GENRE}に関する投稿を1つ作成してください。"}]
          }).encode()

          req = urllib.request.Request(
            'https://api.anthropic.com/v1/messages',
            data=payload,
            headers={
              'Content-Type': 'application/json',
              'x-api-key': CLAUDE_API_KEY,
              'anthropic-version': '2023-06-01'
            }
          )
          res = json.loads(urllib.request.urlopen(req).read())
          text = res['content'][0]['text'].strip()
          print(f"生成された投稿文:\n{text}")

          # 2. Threadsにコンテナ作成
          base = f"https://graph.threads.net/v1.0/{THREADS_USER_ID}"
          params = urllib.parse.urlencode({"media_type": "TEXT", "text": text, "access_token": THREADS_TOKEN})
          req2 = urllib.request.Request(f"{base}/threads?{params}", method='POST')
          container = json.loads(urllib.request.urlopen(req2).read())
          print(f"コンテナID: {container['id']}")

          time.sleep(3)

          # 3. 公開
          params2 = urllib.parse.urlencode({"creation_id": container['id'], "access_token": THREADS_TOKEN})
          req3 = urllib.request.Request(f"{base}/threads_publish?{params2}", method='POST')
          result = json.loads(urllib.request.urlopen(req3).read())
          print(f"✅ 投稿完了！ Post ID: {result['id']}")
          EOF
        env:
          CLAUDE_API_KEY:  ${{ secrets.CLAUDE_API_KEY }}
          THREADS_TOKEN:   ${{ secrets.THREADS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
          GENRE:           ${{ secrets.GENRE }}
